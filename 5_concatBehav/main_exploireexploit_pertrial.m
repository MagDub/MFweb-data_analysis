clear

addpath('./functions/')

load('../usermat_completed.mat')
data_fold = ('../../data/');
dir_data = (strcat(data_fold,'sanity_check/'));
dir_save = (strcat(data_fold,'data_for_figs/'));

Ntrials = 400;
n = size(usermat_completed,2);

% LH

disp('Per trial: Long horizon')

per_trial_exploreexploit_LH_400 = nan(n, Ntrials);

per_trial_exploreexploit_LH_H_400 = nan(n, Ntrials);
per_trial_exploreexploit_LH_M_400 = nan(n, Ntrials);
per_trial_exploreexploit_LH_C_400 = nan(n, Ntrials);
per_trial_exploreexploit_LH_D_400 = nan(n, Ntrials);

per_trial_exploreexploit_LH_H = nan(n, Ntrials/2);
per_trial_exploreexploit_LH_M = nan(n, Ntrials/2);
per_trial_exploreexploit_LH_C = nan(n, Ntrials/2);
per_trial_exploreexploit_LH_D = nan(n, Ntrials/2);

for ID_i = 1:n 
    
    ID = usermat_completed(ID_i);
    
    disp(strcat('User_ID=', num2str(ID)));
        
    for trial_=1:Ntrials %ABD: 87 39 200 177
        
        tmp1 = load(strcat(dir_data, 'user_',num2str(ID),'/logs/logABDlong.mat'));
        tmp2 = load(strcat(dir_data, 'user_',num2str(ID),'/logs/logABlong.mat'));
        tmp3 = load(strcat(dir_data, 'user_',num2str(ID),'/logs/logADlong.mat'));
        tmp4 = load(strcat(dir_data, 'user_',num2str(ID),'/logs/logBDlong.mat'));

        % select only trial
        tmp1.logABDlong(tmp1.logABDlong(:,2)~=trial_,:)=[];
        tmp2.logABlong(tmp2.logABlong(:,2)~=trial_,:)=[];
        tmp3.logADlong(tmp3.logADlong(:,2)~=trial_,:)=[];
        tmp4.logBDlong(tmp4.logBDlong(:,2)~=trial_,:)=[];
        
        % compute explore exploit
        if ~isempty(tmp1.logABDlong)
            isExploitABD = isExploitAB(tmp1.logABDlong);
        elseif ~isempty(tmp2.logABlong)
            isExploitABC = isExploitAB(tmp2.logABlong);
        end
        
        % 39  1
        % 50  1
        % 87  2
        % 200 1

        % keep only choice trials
        tmp1.logABDlong = keeponlychoice(tmp1.logABDlong);
        tmp2.logABlong = keeponlychoice(tmp2.logABlong);
        tmp3.logADlong = keeponlychoice(tmp3.logADlong);
        tmp4.logBDlong = keeponlychoice(tmp4.logBDlong);

        % Keep only 1st sample    
        it1 = tmp1.logABDlong(:,6); % selected tree
        it1(tmp1.logABDlong(:,5)~=6) = []; %50
        if ~isempty(it1)
            if it1==isExploitABD
                it1 = 10;
            elseif it1==4
                it1 = 4;
            else
                it1 = -10;
            end
        end

        it2 = tmp2.logABlong(:,6);
        it2(tmp2.logABlong(:,5)~=5) = []; %50
        if ~isempty(it2)
            if it2==isExploitABC
                it2 = 10;
            elseif it2==3
                it2 = 3;
            else
                it2 = -10;
            end
        end

        it3 = tmp3.logADlong(:,6);
        it3(tmp3.logADlong(:,5)~=5) = []; %50
        if ~isempty(it3)
            if it3==1
                it3 = 10;
            end
        end

        it4 = tmp4.logBDlong(:,6);
        it4(tmp4.logBDlong(:,5)~=3) = []; %50
        if ~isempty(it4)
            if it4==2
                it4 = 10;
            end
        end

        warning('off')
        it_all = [it1, it2, it3, it4];
        
        if ~isempty(it_all)
            per_trial_exploreexploit_LH_400(ID_i,trial_) = it_all; 
        end
        
        if it_all==10
            per_trial_exploreexploit_LH_H_400(ID_i,trial_) = 1; 
            per_trial_exploreexploit_LH_M_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_LH_C_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_LH_D_400(ID_i,trial_) = 0;
        elseif it_all==-10
            per_trial_exploreexploit_LH_H_400(ID_i,trial_) = 0; 
            per_trial_exploreexploit_LH_M_400(ID_i,trial_) = 1; 
            per_trial_exploreexploit_LH_C_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_LH_D_400(ID_i,trial_) = 0; 
        elseif it_all==3
            per_trial_exploreexploit_LH_H_400(ID_i,trial_) = 0; 
            per_trial_exploreexploit_LH_M_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_LH_C_400(ID_i,trial_) = 1; 
            per_trial_exploreexploit_LH_D_400(ID_i,trial_) = 0;  
        elseif it_all==4
            per_trial_exploreexploit_LH_H_400(ID_i,trial_) = 0; 
            per_trial_exploreexploit_LH_M_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_LH_C_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_LH_D_400(ID_i,trial_) = 1; 
        end

    end
    
    tmp_H = per_trial_exploreexploit_LH_H_400(ID_i,:);
    tmp_M = per_trial_exploreexploit_LH_M_400(ID_i,:);
    tmp_C = per_trial_exploreexploit_LH_C_400(ID_i,:);
    tmp_D = per_trial_exploreexploit_LH_D_400(ID_i,:);
    
    tmp_H(isnan(tmp_H)) = []; 
    tmp_M(isnan(tmp_M)) = []; 
    tmp_C(isnan(tmp_C)) = [];
    tmp_D(isnan(tmp_D)) = [];
    
    for trial_=1:Ntrials/2 
         tmp_H_exploreexploit(trial_) = sum(tmp_H(1:trial_))/trial_;
         tmp_M_exploreexploit(trial_) = sum(tmp_M(1:trial_))/trial_;
         tmp_C_exploreexploit(trial_) = sum(tmp_C(1:trial_))/trial_;
         tmp_D_exploreexploit(trial_) = sum(tmp_D(1:trial_))/trial_;
    end
    
    per_trial_exploreexploit_LH_H(ID_i, :) = tmp_H_exploreexploit*100;
    per_trial_exploreexploit_LH_M(ID_i, :) = tmp_M_exploreexploit*100;
    per_trial_exploreexploit_LH_C(ID_i, :) = tmp_C_exploreexploit*100;
    per_trial_exploreexploit_LH_D(ID_i, :) = tmp_D_exploreexploit*100;
    
    tmp_all = per_trial_exploreexploit_LH_400(ID_i,:);
    tmp_all(isnan(tmp_all)) = []; 
    per_trial_LH_all_HMCD(ID_i, :) = tmp_all;

end

% SH

disp('Per trial: Short horizon')

per_trial_exploreexploit_SH_400 = nan(n, Ntrials);

per_trial_exploreexploit_SH_H_400 = nan(n, Ntrials);
per_trial_exploreexploit_SH_M_400 = nan(n, Ntrials);
per_trial_exploreexploit_SH_C_400 = nan(n, Ntrials);
per_trial_exploreexploit_SH_D_400 = nan(n, Ntrials);

per_trial_exploreexploit_SH_H = nan(n, Ntrials/2);
per_trial_exploreexploit_SH_M = nan(n, Ntrials/2);
per_trial_exploreexploit_SH_C = nan(n, Ntrials/2);
per_trial_exploreexploit_SH_D = nan(n, Ntrials/2);

for ID_i = 1:n 
    
    ID = usermat_completed(ID_i);
    
    disp(strcat('User_ID=', num2str(ID)));
        
    for trial_=1:Ntrials
        
        tmp1 = load(strcat(dir_data, 'user_',num2str(ID),'/logs/logABDshort.mat'));
        tmp2 = load(strcat(dir_data, 'user_',num2str(ID),'/logs/logABshort.mat'));
        tmp3 = load(strcat(dir_data, 'user_',num2str(ID),'/logs/logADshort.mat'));
        tmp4 = load(strcat(dir_data, 'user_',num2str(ID),'/logs/logBDshort.mat'));

        % select only trial
        tmp1.logABDshort(tmp1.logABDshort(:,2)~=trial_,:)=[];
        tmp2.logABshort(tmp2.logABshort(:,2)~=trial_,:)=[];
        tmp3.logADshort(tmp3.logADshort(:,2)~=trial_,:)=[];
        tmp4.logBDshort(tmp4.logBDshort(:,2)~=trial_,:)=[];
        
        % compute explore exploit
        if ~isempty(tmp1.logABDshort)
            isExploitABD = isExploitAB(tmp1.logABDshort);
        elseif ~isempty(tmp2.logABshort)
            isExploitABC = isExploitAB(tmp2.logABshort);
        end

        % keep only choice trials
        tmp1.logABDshort = keeponlychoice(tmp1.logABDshort);
        tmp2.logABshort = keeponlychoice(tmp2.logABshort);
        tmp3.logADshort = keeponlychoice(tmp3.logADshort);
        tmp4.logBDshort = keeponlychoice(tmp4.logBDshort);

        % Keep only 1st sample    
        it1 = tmp1.logABDshort(:,6); % selected tree
        it1(tmp1.logABDshort(:,5)~=6) = []; %50
        if ~isempty(it1)
            if it1==isExploitABD
                it1 = 10;
            elseif it1==4
                it1 = 4;
            else
                it1 = -10;
            end
        end

        it2 = tmp2.logABshort(:,6);
        it2(tmp2.logABshort(:,5)~=5) = []; %50
        if ~isempty(it2)
            if it2==isExploitABC
                it2 = 10;
            elseif it2==3
                it2 = 3;
            else
                it2 = -10;
            end
        end

        it3 = tmp3.logADshort(:,6);
        it3(tmp3.logADshort(:,5)~=5) = []; %50
        if ~isempty(it3)
            if it3==1
                it3 = 10;
            end
        end

        it4 = tmp4.logBDshort(:,6);
        it4(tmp4.logBDshort(:,5)~=3) = []; %50
        if ~isempty(it4)
            if it4==2
                it4 = 10;
            end
        end

        warning('off')
        it_all = [it1, it2, it3, it4];
        
        if ~isempty(it_all)
            per_trial_exploreexploit_SH_400(ID_i,trial_) = it_all; 
        end
        
        if it_all==10
            per_trial_exploreexploit_SH_H_400(ID_i,trial_) = 1; 
            per_trial_exploreexploit_SH_M_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_SH_C_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_SH_D_400(ID_i,trial_) = 0;
        elseif it_all==-10
            per_trial_exploreexploit_SH_H_400(ID_i,trial_) = 0; 
            per_trial_exploreexploit_SH_M_400(ID_i,trial_) = 1; 
            per_trial_exploreexploit_SH_C_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_SH_D_400(ID_i,trial_) = 0; 
        elseif it_all==3
            per_trial_exploreexploit_SH_H_400(ID_i,trial_) = 0; 
            per_trial_exploreexploit_SH_M_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_SH_C_400(ID_i,trial_) = 1; 
            per_trial_exploreexploit_SH_D_400(ID_i,trial_) = 0;  
        elseif it_all==4
            per_trial_exploreexploit_SH_H_400(ID_i,trial_) = 0; 
            per_trial_exploreexploit_SH_M_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_SH_C_400(ID_i,trial_) = 0;
            per_trial_exploreexploit_SH_D_400(ID_i,trial_) = 1; 
        end

    end
    
    tmp_H = per_trial_exploreexploit_SH_H_400(ID_i,:);
    tmp_M = per_trial_exploreexploit_SH_M_400(ID_i,:);
    tmp_C = per_trial_exploreexploit_SH_C_400(ID_i,:);
    tmp_D = per_trial_exploreexploit_SH_D_400(ID_i,:);
    
    tmp_H(isnan(tmp_H)) = []; 
    tmp_M(isnan(tmp_M)) = []; 
    tmp_C(isnan(tmp_C)) = [];
    tmp_D(isnan(tmp_D)) = [];
    
    for trial_=1:Ntrials/2 
         tmp_H_exploreexploit(trial_) = sum(tmp_H(1:trial_))/trial_;
         tmp_M_exploreexploit(trial_) = sum(tmp_M(1:trial_))/trial_;
         tmp_C_exploreexploit(trial_) = sum(tmp_C(1:trial_))/trial_;
         tmp_D_exploreexploit(trial_) = sum(tmp_D(1:trial_))/trial_;
    end
    
    per_trial_exploreexploit_SH_H(ID_i, :) = tmp_H_exploreexploit*100;
    per_trial_exploreexploit_SH_M(ID_i, :) = tmp_M_exploreexploit*100;
    per_trial_exploreexploit_SH_C(ID_i, :) = tmp_C_exploreexploit*100;
    per_trial_exploreexploit_SH_D(ID_i, :) = tmp_D_exploreexploit*100;
    
    tmp_all = per_trial_exploreexploit_SH_400(ID_i,:);
    tmp_all(isnan(tmp_all)) = []; 
    per_trial_SH_all_HMCD(ID_i, :) = tmp_all;

end

% mean(per_trial_exploreexploit_SH_H(:,end))
% mean(per_trial_exploreexploit_LH_H(:,end))


% Save

per_trial_exploreexploit_desc = ['ID' 'exploreexploituency over trial x'];

save(strcat(dir_save, 'per_trial_exploreexploit_desc.mat'), 'per_trial_exploreexploit_desc');

per_trial_SH_all_HMCD = [usermat_completed' per_trial_SH_all_HMCD];
per_trial_LH_all_HMCD = [usermat_completed' per_trial_LH_all_HMCD];

per_trial_exploreexploit_SH_H = [usermat_completed' per_trial_exploreexploit_SH_H];
per_trial_exploreexploit_SH_M = [usermat_completed' per_trial_exploreexploit_SH_M];
per_trial_exploreexploit_SH_C = [usermat_completed' per_trial_exploreexploit_SH_C];
per_trial_exploreexploit_SH_D = [usermat_completed' per_trial_exploreexploit_SH_D];

per_trial_exploreexploit_LH_H = [usermat_completed' per_trial_exploreexploit_LH_H];
per_trial_exploreexploit_LH_M = [usermat_completed' per_trial_exploreexploit_LH_M];
per_trial_exploreexploit_LH_C = [usermat_completed' per_trial_exploreexploit_LH_C];
per_trial_exploreexploit_LH_D = [usermat_completed' per_trial_exploreexploit_LH_D];

save(strcat(dir_save, 'per_trial_SH_all_HMCD.mat'), 'per_trial_SH_all_HMCD');
save(strcat(dir_save, 'per_trial_LH_all_HMCD.mat'), 'per_trial_LH_all_HMCD');

save(strcat(dir_save, 'per_trial_exploreexploit_SH_H.mat'), 'per_trial_exploreexploit_SH_H');
save(strcat(dir_save, 'per_trial_exploreexploit_LH_H.mat'), 'per_trial_exploreexploit_LH_H');

save(strcat(dir_save, 'per_trial_exploreexploit_SH_M.mat'), 'per_trial_exploreexploit_SH_M');
save(strcat(dir_save, 'per_trial_exploreexploit_LH_M.mat'), 'per_trial_exploreexploit_LH_M');

save(strcat(dir_save, 'per_trial_exploreexploit_SH_C.mat'), 'per_trial_exploreexploit_SH_C');
save(strcat(dir_save, 'per_trial_exploreexploit_LH_C.mat'), 'per_trial_exploreexploit_LH_C');

save(strcat(dir_save, 'per_trial_exploreexploit_SH_D.mat'), 'per_trial_exploreexploit_SH_D');
save(strcat(dir_save, 'per_trial_exploreexploit_LH_D.mat'), 'per_trial_exploreexploit_LH_D');


%
% per_trial_exploreexploit_LH_400
save(strcat(dir_save, 'per_trial_exploreexploit_LH_400.mat'), 'per_trial_exploreexploit_LH_400');
save(strcat(dir_save, 'per_trial_exploreexploit_SH_400.mat'), 'per_trial_exploreexploit_SH_400');



